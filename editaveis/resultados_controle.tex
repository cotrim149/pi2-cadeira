\chapter[Resultados]{Resultados}

A partir do estudo e pesquisa realizado até o momento determinamos o que utilizar no conjunto do sistema, levantando um perfil que a equipe acredita ser a mais viável em termos de interação, custo-benefício, tempo, conhecimento técnico e outros fatores importantes para o projeto. Será desenvolvido um kit com capacidade de ser acoplado em diversas cadeiras de rodas afim de facilitar a mobilidade elétrica em cadeiras manuais. Os resultados levantados estão disposto no decorrer do capítulo.

\section{Estrutura}

Com a utilização do programa CATIA V5 3D foi estruturado o sistema eletrônico acoplado à cadeira de rodas, \ref{fig:vista_isometrica_traseira}. Visando três preceitos básicos: comodidade, acessibilidade e conforto.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.4]{figuras/estrutura/vista_isometrica_traseira}
\caption{Vista Isométrica Traseira}
\label{fig:vista_isometrica_traseira}
\end{figure}

O objetivo do projeto é desenvolver uma estrutura de fácil conexão e resistente. O produto proposto, ver figura \ref{fig:traseira}, \ref{fig:sistema}, \ref{fig:lateral} e \ref{fig:superior},deve-se acoplar a qualquer cadeira de rodas.

Foi pensado em um dispositivo no formato de uma mala para que seja de fácil conexão, uso e manuseio.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.4]{figuras/estrutura/vista_traseira}
\caption{Vista Traseira}
\label{fig:traseira}
\end{figure}

A forma como a mala será acoplada a cadeira usa como base as hastes da mala e as hastes verticais aonde as manoplas utilizadas para empurrar manualmente a cadeira são fixadas. Tendo em vista que são rígidas e normatizadas pela NBR 9050 as hastes verticais da cadeira tem a distancia e espessura já definidas, o que facilita o desenvolvimento de um produto que possa ser usado em qualquer cadeira de rodas que esteja dentro dos padrões impostos pela norma.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.4]{figuras/estrutura/explode}
\caption{Visão do Sistema}
\label{fig:sistema}
\end{figure}

Cada roda possuirá um motor próprio para que seja possível rotaciona-lás em sentidos opostos, por exemplo, quando for necessário fazer manobras em que a rotação deve ocorre em torno do eixo do próprio cadeirante, movimento muito comum para manobrar uma cadeira de rodas. Assim o cadeirante se sentira confortável e não terá grandes dificuldades quando for manobrar a cadeira, já que a lógica de controle será a mesma usada quando se propulsiona manualmente a cadeira.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.4]{figuras/estrutura/vista_lateral_cadeira}
\caption{Imagem Lateral}
\label{fig:lateral}
\end{figure}

Como pode se notar nas figuras, o sistema de propulsão devera empurrar a cadeira de rodas, pois assim podemos aproximar o máximo possível o eixo da roda que ira gerar o movimento ao eixo da maior roda da cadeira, o que diminui a quantidade de torque necessário para movimentar o conjunto, fazendo com que o consumo de energia diminua e possibilite o uso de um motor de menor potencia, que diminuirá o custo do produto final.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.4]{figuras/estrutura/vista_superior}
\caption{Imagem Superior}
\label{fig:superior}
\end{figure}

\subsection{Protótipo}

A partir do policloreto de vinila, usualmente conhecido como PVC, foi feita uma estrutura de teste para encaixar na parte de trás da cadeira de rodas, com o intuito de buscar a melhor regulação to tamanho da estrutura. O protótipo em questão foi feito para se chegar o mais próximo de um modelo ideal capaz de se acoplar as cadeiras regulamentadas pela NBR 9050.

O protótipo é uma estrutura retangular com uma alça de regulação de largura, seguido de dois “joelhos” em PVC para o acoplamento das rodinhas e da haste, dois encaixes com três saídas para regulação da barra de encaixe superior da cadeira. Há quatro furos na barra de regulação de largura, a qual serve para se adequar ao tipo de cadeira de rodas sendo utilizada, vide figura para mais detalhes \ref{fig:acoplamento}.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.7]{figuras/resultados/acoplamento}
\caption{Estrutura de acoplamento}
\label{fig:acoplamento}
\end{figure}

No protótipo foram usadas oito braçadeiras circulares de curso infinito, as quais se acoplam na cadeira de rodas dando rigidez a estrutura, dessas oito braçadeiras, duas na parte inferior se acoplam na parte de baixo da cadeira, outras duas se acoplam na parte superior. A figura \ref{fig:acop_bracadeira} ilustra o sistema de acoplamento estrutura/cadeira.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.7]{figuras/resultados/acop_bracadeira}
\caption{Sistema de acoplamento com braçadeira}
\label{fig:acop_bracadeira}
\end{figure}

Na parte da estrutura mostrada na figura \ref{fig:acop_bracadeira} existem dois “joelhos” que ligam as rodinhas com o as barras de PVC, além de uma barra em paralelo com a barra das rodinhas, capaz de variar em altura e largura para se adequar ao tamanho da cadeira utilizada, e  duas braçadeiras nas pontas das barras que irão se acoplar a cadeira de rodas.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.7]{figuras/resultados/superior_estrutura}
\caption{Parte superior da estrutura}
\label{fig:superior_estrutura}
\end{figure}

A figura \ref{fig:superior_estrutura} representa a parte superior da estrutura, ela contem dois “joelhos” capazes de ligar as duas alças com as duas barras de sustentação da estrutura. Há dois “T” com furo que ligam três barras de cada lado, eles tem a função de regular a altura com o seis furos nas barras de movimentação. Na alça estão duas braçadeiras livres, que se ligam na parte superior da cadeira de rodas, assim como a parte superior já descrita.

Os componentes utilizados para se fazer este modelo são descritos:
\begin{itemize}
  \item Oito braçadeiras circulares de curso infinito;
  \item Quarto “joelhos” de 90$^\circ$;
  \item Dois “T”;
  \item Duas rodas;
  \item Barras de PVC com diâmetros de 20mm e 25mm;
  \item Quatro parafusos;
  \item Oito arruelas;
  \item Quatro porcas.
\end{itemize}

O protótipo apresentado na figura \ref{fig:estr_prototipo} foi capaz de mostrar como funcionará o sistema, e todo encaixe necessário para não ocorrer folga e desconforto ao cadeirante. Esta estrutura se assemelha com as medidas do sistema original, mudando apenas o material da execução e do funcionamento. Obteve-se excelentes resultados testando tal protótipo em dois modelos de cadeira de rodas.

\begin{figure}[!htb]
\centering
\includegraphics[keepaspectratio=true,scale=0.7]{figuras/resultados/estr_prototipo}
\caption{Estrutura acoplada a cadeira}
\label{fig:estr_prototipo}
\end{figure}

\section{Power-Train}

\subsection[Resistência a Rolagem]{Resistência a Rolagem}
Segundo \cite{propulsao_cadeira}, os fatores que determinam a resistência ao rolamento são: os coeficientes de atrito das rodas traseiras e dianteiras, o peso total do sistema (cadeira e usuário), a superfície em que a cadeira está sendo impulsionada e a distribuição de peso entre as rodas traseiras e dianteiras através do centro de massa (Cm).

A figura \ref{fig:diagrama_variaveis} a seguir é um diagrama que ilustra as variáveis que determinam a resistência de rolagem da cadeira de rodas manual. Estas variáveis são: o comprimento da roda (\textit{dwb}), a distância horizontal do eixo das rodas traseiras ao centro de massa (\textit{x}) e a distância horizontal do eixo das rodas dianteiras ao centro de massa (\textit{dwb-x}).

As forças presentes no diagrama representam as forças peso das rodas traseiras (\textit{fr}) e das dianteiras (\textit{fc}), que fazem parte das forças de resistência ao rolamento: \textit{fr,rr} das rodas traseiras e \textit{fc,rr} das rodas dianteiras. Nas equações abaixo: $\mu$ é o coeficiente de fricção de rolagem, $m$ é a massa e $g$ é a aceleração da gravidade \cite{propulsao_cadeira}:

\begin{equation}
f_r= m*g \frac{(dwb-x)}{dwb}   e  f_{r,rr}= \mu*f_r
\end{equation}
\begin{equation}
f_c=m*g \frac{x}{dwb}   e  f_{c,rr}= \mu*f_c
\end{equation}
\begin{equation}
f_rr=f_{c,rr}+ f_{r,rr}  
\end{equation}

A resistência ao rolamento frr é, por fim, a soma das resistências das rodas dianteiras e traseiras.

\begin{figure}[!htb]
\centering
\includegraphics[width = 0.9\textwidth]{figuras/resultados/diagrama_variaveis}
\caption{Diagrama das variáveis que determinam a resistência de rolagem da cadeira de rodas manual. \cite{propulsao_cadeira}.}
\label{fig:diagrama_variaveis}
\end{figure}

Ao acoplar o protótipo criado para automatizar a cadeira de rodas, acrescenta-se um peso a mais ao sistema, assim como um ponto a mais de contato de distribuição da massa total é adicionado ao sistema. Desta maneira, as forças nas rodas traseiras são aliviadas por serem divididas com as rodas do protótipo. A figura \ref{fig:finalmente_essa_imagem} abaixo apresenta as distâncias entre os eixos das rodas da cadeira e do protótipo ao centro de massa.

\begin{figure}[!htb]
\centering
\includegraphics[width = 0.9\textwidth]{figuras/resultados/finalmente_essa_figura}
\caption{Diagrama das Variáveis para determinação da Resistência de Rolagem com o protótipo acoplado. FONTE: própria autoria.}
\label{fig:finalmente_essa_imagem}
\end{figure}

Desta maneira, as equações discutidas anteriormente são modificadas para se ajustarem ao protótipo acoplado, onde s é a distância entre as rodas do protótipo e o centro de massa (Cm) e \textit{dwb} é a distância entre o eixo das rodas dianteiras e as rodas do protótipo:

\begin{equation}
f_p = m*g \frac{(dwb-s-x)}{dwb}   e  f_{p,rr}= \mu*f_p
\end{equation}
\begin{equation}
f_r = m*g \frac{(dwb-s)}{dwb}   e  f_{r,rr}= \mu*f_r
\end{equation}
\begin{equation}
f_c=m*g \frac{x}{dwb}   e  f_{c,rr}= \mu*f_c
\end{equation}
\begin{equation}
f_{rr}=f_{c,rr}+ f_{r,rr}+ f_{p,rr}
\end{equation}

As constantes usadas nestes cálculos foram: 

\begin{itemize}
\item $\mu$ = 0,03 \cite{rolling_resistance} – constante estimada para o pior piso e pior tipo de material da roda;

\item m = 150 kg (massa máxima);

\item g = 9.81 m/s2;

\item dwb = 72 cm;

\item s = 36 cm;

\item x = 6 cm;

\end{itemize}

Os resultados das forças de resistência ao rolamento são, portanto:

\begin{itemize}
\item fp,rr = 18.394 N;

\item fr,rr = 22.073 N;

\item fc,rr = 3.6787 N;

\item frr = 44.146 N;

\end{itemize}

Esta força deve ser vencida pelos motores acoplados ao protótipo de modo a retirar a cadeira da inércia quando todas as rodas da cadeira estão alinhadas para frente perfeitamente. Porém, isto nem sempre acontece.

Portanto foi feita uma simulação para quando as rodas dianteiras estão paralelas às rodas traseiras. Nesta configuração, as rodas dianteiras fornecem uma resistência a mais ao movimento. Esta resistência foi considerada como uma resistência de atrito estático e depende do coeficiente de atrito estático do material das rodas dianteiras ($\mu e$) e da fração da massa suportada nas rodas dianteiras que pode ser definida como:

\begin{equation}
c = \frac{x}{dwb}
\end{equation}

A resistência adicional pode ser definida, portanto, como:

\begin{equation}
f_{ce}= m*g* \mu_e \frac{x}{dwb}
\end{equation}

A resistência total ao movimento (fT) seria portanto a soma das resistências de rolamento com a de atrito estático:

\begin{equation}
f_T = f_{rr} + f_{ce} = 44.146+61.312 = 105.46 N
\end{equation}

Isto exige um torque inicial de 10.546 Nm (dado que os raios das rodas do protótipo são de 10 cm). Portanto, pode-se dizer que, nesta situação, a potência necessária para retirar a cadeira da inércia é de:

\begin{equation}
P = T*\omega = 10.546*26.18 = 276.09 W
\end{equation}

	A potência entregue pelos motores à cadeira de rodas, já considerando as perdas, é de cerca de 583 W. A diferença entre a entregue e a necessária para retirar a cadeira da inércia é considerável, o que poderia causar um arranque repentino do sistema. Este tranco poderia prejudicar o usuário assim como a cadeira. A solução para este problema está no uso de pontes H, que fornecem corrente aos motores de forma gradativa a medida que o usuário empurra o joystick, diminuindo o arranque do protótipo.

\subsection{Moto-redutor}

Será utilizado no projeto o motor de corrente contínua. A escolha foi feita pois esse tipo de motor é muito utilizado em projetos que necessitam de velocidades variáveis, eles também apresentam uma região de torque e potência constante e são simples de realizar a aceleração e a desaceleração \cite{manual_bateria_unipower}.

Após uma vasta pesquisa no mercado de motores e redutores, optou-se por comprar dois moto-redutores feitos pela empresa MKS Redutores de São Paulo. O motor com redutor escolhido para o projeto foi o MR com motor GPB que possui as seguintes especificações:

\begin{itemize}
  \item Potência de 305 a 350 W;
  \item 12 ou 24 Vcc;
  \item Rotação de entrada de 2500 rpm;
  \item Reduções de 1:10 até 1:60.
\end{itemize}

Especificações a serem atendidas:

\begin{itemize}
  \item Velocidade máxima de 10 km/h;
  \item 12 Volts corrente contínua;
  \item Peso da bateria 15 kg;
  \item Peso da cadeira (valor aproximado) 15kg;
  \item Peso total estimado: 150 Kg;
  \item Redução de pelo menos 1:10.
\end{itemize}

\subsection{Bateria}

A bateria de chumbo-ácido é muito utilizada hoje em dia em diferentes áreas, como automóveis, sistemas de fornecimento de energia elétrica ininterrupta (no-breaks) e cadeiras de rodas elétricas. Desprezando-se o problema do peso e considerando as observações feitas anteriormente no capítulo \ref{cap:fundamentacao_teorica}, a bateria de chumbo-ácido selada foi a escolhida para o projeto, considerando ainda o seu fácil acesso no mercado e baixo custo.

\subsubsection{Autonomia}

Segundo a literatura, cadeiras de rodas elétricas trabalham com motores de corrente contínua entre 250 W a 300 W de potência. Há diversas maneiras de chegar neste valor, como por distribuição de forças, por balanço de energia, por forças em um plano inclinado, entre outras. Para este projeto fez-se uma estimativa da potência necessária através do balanço de energia \cite{acionamento_motores_cadeira}.

A energia fornecida pelo motor deve ser igual à energia cinética da cadeira. Sendo a massa máxima que a cadeira de rodas aguenta de 150 kg e considerando que cadeiras de rodas elétricas chegam até 10 km/h, tem-se:


\begin{equation}
  Em = \frac{m*V^2}{2}
\end{equation}

Onde $Em$ é a energia fornecida pelo motor, $m$ é a massa de 150 kg e $V$ é a velocidade de 2.77 m/s. Assim, a energia necessária para mover a cadeira é de 578.7 J. Sendo 1 Watt igual a 1 J/s, tem-se, portanto, 578.7 W.

Após uma pesquisa no mercado, foram adquiridos dois motores de corrente contínua de 12 Volts e 305 Watts para o projeto, assim, a potência total entregue ao sistema é de 610 W. Este tipo de motor possui perdas de potência tanto mecânicas (\textit{Pm}) quanto térmicas (\textit{Pj}) \cite{perdas}. A primeira está associada a perdas por causa da velocidade: por atrito, nas escovas do motor e por curto-circuito; estima-se que estas juntas sejam cerca de 3 a 5\% da potência nominal do motor.

As perdas térmicas estão associadas ao efeito Joule: os fios usados nos enrolamentos dos motores apresentam certa resistência elétrica. A corrente entregue para o motor, em máxima potência é dada pela divisão da potência pela tensão do motor: \textit{I} = 25.417 A. Desta forma, a resistência \textit{R} pode ser calculada pela fórmula da potência a seguir:

\begin{equation}
P = R*I, assim, R = \frac{305}{25.417^2} = 0.47231 \ohm
\end{equation}

As perdas nos enrolamentos (Pj) é portanto:

\begin{equation}
Pj = R*I = 0.47213*25.417 = 12 W
\end{equation}

As perdas totais (Pt) são, portanto:

\begin{equation}
Pt = Pj+Pm = 12+(305*0.05) = 27.25 W
\end{equation}

Estas perdas representam cerca de 9\% da potência nominal do motor. Desta maneira, se deve adicionar um termo de perdas a serem superadas pelos motores à equação da energia, este termo $\epsilon$ seria igual a 1.09:

\begin{equation}
  Em = \frac{m*V^2*\epsilon}{2}
\end{equation}

Assim, a energia necessária para mover a estrutura seria de 630.434 J, ou 630.434 W de potência. Para encontrar o valor da velocidade final do sistema é preciso rearranjar a equação acima. Uma eficiência de 80\% foi atribuída ao acoplamento das rodas com o eixo do motor. Estes 20\% englobam as perdas no redutor, perdas por escorregamento da conexão do redutor e da roda com o chão, entre outros. Assim, temos:

\begin{equation}
Em = 0.8*\sqrt{\frac{600*2}{m*\epsilon}}
\end{equation}

Assim, a estimativa da velocidade máxima que a cadeira deve obter será de aproximadamente 8.6 km/h, que é uma velocidade bem razoável para este tipo de sistema. Sabe-se que a velocidade angular é dada pela divisão da velocidade linear pelo raio:

\begin{equation}
\omega = \frac{V}{r}
\end{equation}

Logo, utilizando a velocidade estimada acima, a velocidade angular obtida é de 23.9 rad/s ou 228.31 rpm. Considerando as especificações do motor, sua velocidade angular nominal de 2500 rpm, teria de ser feita uma redução de pelo menos 1:11, onde a velocidade angular de saída do redutor seria de 227.3 rpm. 

Por motivos construtivos do motoredutor, a redução só pode ser feita de 1:10 ou de 1:15. Desta forma optou-se por uma redução de 1:10, que proporciona velocidade de saída nominal de 250 rpm (26.18 rad/s) no redutor. Sendo o torque a divisão da potência pela velocidade angular, o torque gerado é de 23.30 Nm.

Para atender dois motores de 305 W, será conectada uma bateria de carro de chumbo-ácido selado de 12 V (U) e capacidade de 60Ah (I*$\Delta$t), tem-se que a energia $E$ gerada pela bateria é de:

\begin{equation}
E = (I*\Delta t)*U = (60Ah)*12 = 720Wh
\end{equation}

Desta forma, considerando a potência consumida pelos dispositivos eletrônicos de controle desprezível, tem-se que a autonomia da bateria seria de pouco mais de uma hora:

\begin{equation}
\Delta t = \frac{720 Wh}{610 W} = 1.18 h = 1 hora e 10 minutos
\end{equation}

\section{Controle}

\begin{comment}
-------------------------------------------------------------------------------
---- Tópicos para a escrita da parte de controle do capítulo de resultados ----
-------------------------------------------------------------------------------
Panororama do sistema de controle conforme Arquitetura
  - Desde controle de software a periféricos (Usuário a Motor)
  - Panorama de Arquitetura - Antes e depois
    - Citar melhoria quanto ao desempenho
  - Estratégia de comunição entre componentes - Antes e depois
  - Integração Joystick e motor - Falar sobre os estados
\end{comment}

\subsection{Joystick}

O módulo Joystick é a interface de ligação entre o usuário e a cadeira de rodas, este componente é composto por um \textit{joystick} (alavanca que se move sobre uma base e capta movimentos em dois eixos) e um microcontrolador.

Toda a forma de interação entre o usuário e a cadeira de rodas é feita a partir do Joystick, a figura \ref{fig:joy_hand_control} dá uma noção das dimensões e ergonomia deste componente. O controle que fica nas mãos do usuário é conectado à cadeira de rodas por meio de um cabo $RJ45$, apenas o \textit{joystick} foi colocado dentro do controle, o microcontrolador dedicado a este módulo foi colocado junto ao controlador central na traseira da cadeira, para uma maior segurança do mesmo.

\begin{figure}[!htb]
\centering
\includegraphics[width = 0.5\textwidth]{figuras/resultados/joy_hand_control}
\caption{Imagem do controle da cadeira de rodas}
\label{fig:joy_hand_control}
\end{figure}

O \textit{joystick} utilizado é composto por dois potenciômetros que indicam as posições em dois eixos independentes. Utilizando os potenciômetros como simples divisores de tensão é possível inferir as posições de seus eixos a partir da medições das tensões do circuito, para realizar esta medição e então rastrear o comando de movimento do usuário, são utilizados dois canais de conversores AD para os potenciômetros, tais conversores são internos ao microcontrolador utilizado e não necessitam de nenhum \textit{hardware} extra.

A rotina de trabalho do microcontrolador do módulo Joystick consiste em adquirir os valores analógicos das posições do \textit{joystick}, convertê-los em valores digitais de um \textit{byte} cada, diferenciando-os utilizando a estratégia de representar um eixo apenas por valores ímpares e o outro apenas por valores pares (ambos entre 0 e 255) e enviá-los via serial alternadamente em um laço infinito, conforme a figura \ref{fig:joy_fluxogram}.

\begin{figure}[!htb]
\centering
\includegraphics[width = 0.9\textwidth]{figuras/resultados/joy_fluxogram}
\caption{Rotina de trabalho do microcontrolador do módulo Joystick}
\label{fig:joy_fluxogram}
\end{figure}

\begin{comment}

Joystick
  - Software e Hardware (periféricos e MSP Joystick)
    - Colocar imagem de código
  - Interface de usuário
    - Fotos do controle

\end{comment}

\subsection{Controlador Central}

  O Raspberry será utilizado como central de comandos para processar as informações vindas do MSP dedicado ao módulo Joystick e enviar o resultado deste processamento para o MSP dedicado aos Motores.

  \textbf{Comunição entre MSP e Raspberry}

  A comunicação, tanto entre o MSP do Josytick e o Raspberry, quanto entre o MSP do Motor e o Raspberry, estão sendo feitas via \textit{threads}.

  A conexão entre os MSP foi formulada através do método \textit{findPort}. Sua implementação pode ser observada na figura \ref{fig:find_port_method}.

  \begin{figure}[!htb]
    \centering
    \includegraphics[width=0.9\textwidth]{figuras/resultados/find_port_method}
    \caption{Método para encontrar porta dinamicamente}
    \label{fig:find_port_method}
  \end{figure}

  Este método permite que tanto o MSP do Joystick quanto o MSP do Motor, sejam conectados sem a previa identificação de qual porta utilizar para comunicação. Porém, há existência de prioridade entre as \textit{threads}, ou seja, enquanto a \textit{threads} do Joystick não se conectar com sucesso a \textit{threads} do Motor não irá se conectar.

  Para que este processo ocorra com sucesso, uma checagem de dados é feita para cada tentativa de conexão. Esta checagem consiste em verificar se a porta, a ser conectada, está enviando dados ou recebendo. Para que a conexão do Josytick ocorra com sucesso, a porta deva estar recebendo dados, para que a conexão do Motor ocorra com sucesso, a porta não deve enviar dados. A implementação desta checagem pode ser verificada na figura \ref{fig:try_receive_data}.

  \begin{figure}[!htb]
  \centering
  \includegraphics[keepaspectratio=true,scale=0.5]{figuras/resultados/try_receive_data}
  \caption{Método para checar se existe recebimento de dados em porta. Caso do Motor.}
  \label{fig:try_receive_data}
  \end{figure}

  Esta estratégia auxilia na manutenção do produto, pois caso algum MSP fique inutilizavel, é possivel colocar outro MSP, previamente configurado, no lugar do componente inutilizado.

  Após o Raspberry conseguir encontrar uma porta para se conectar com o MSP do Joystick, então a \textit{thread} do MSP do Motor utiliza do mesmo método para se conectar.

  Ao se ter as duas conexões estabelecidas, então o recebimento de dados são adquiridos do Joystick e enviados para os Motores. Para se fazer este envio de informações de forma correta é necessário fazer a sincronização entre as \textit{threads}.

  \textbf{Sincronização de \textit{Threads}}

  Foi percebido que as \textit{threads} precisam estar sincronizadas para se fazer o envio de informações de forma correta. Pois a \textit{thread} do Joystick recebe as informações, e a \textit{thread} do Motor consome estas informações.

  Este problema de sincronização das \textit{threads} é conhecido como um clássico problema de \textit{threads}: Produtor e Consumidor.

  Este problema é caracterizado por 2 processo que compartilharem de um \textit{buffer} comum, no qual o produtor insere a informação no \textit{buffer} e o consumidor retira a informação do \textit{buffer}. Possíveis problemas: Produtor insere produto onde não foi consumido e consumidor remove informação onde já foi removido. Mais detalhes do problema no capítulo \ref{cap:fundamentacao_teorica}.

  Este problema foi solucionado com os seguintes passos:
  \begin{enumerate}
    \item Produtor: Produz os itens necessários em \textit{buffer}, no caso os valores referentes aos potenciometros do Joystick. Neste momento a \textit{thread} do Consumidor é parada e uma variável responsável por esta trava é notificada. Isto pode ser visto na figura \ref{fig:joy_lock};
    \item Consumidor: Consume os itens em \textit{buffer} enviado os mesmos para o MSP dos Motores. Neste momento a \textit{thread} do Produtor é parada e a variável responsável pela trava é consumida. Isto pode ser visto na figura \ref{fig:motor_lock};
  \end{enumerate}

  A variável de trava é utilizada com o propósito de se fazer a produção e o consumo de forma sincronizada. O processo do Consumidor somente será ativo quando o processo do Produtor setar a variável de trava.

  \begin{figure}[!htb]
  \centering
  \includegraphics[keepaspectratio=true,scale=0.5]{figuras/resultados/joy_lock}
  \caption{Código utilizado para notificar variável de trava}
  \label{fig:joy_lock}
  \end{figure}

  \begin{figure}[!htb]
  \centering
  \includegraphics[width=0.9\textwidth]{figuras/resultados/motor_lock}
  \caption{Código utilizado para consumir itens e consequentemente a variável de trava}
  \label{fig:motor_lock}
  \end{figure}


\subsection{Integração Motor e Joystick}

Para se fazer a movimentação da cadeira de forma correta, foi feito um mapeamento dos possíveis estados de movimentação. Estes estados foram inicialmente mapeados utilizando os valores do módulo do Joystick. Com base nos estados mapeados, a intensidade e direção dos motores são formulados. Esta integração foi implementada na Raspberry.

  \textbf{Mapeamento dos Estados em Relação ao Joystick}

  Estes estados, vide tabela \ref{tab:tabela-pots}, são formalizados a partir das possibilidades de valores que podem ser capturados do módulo Joystick.

  Os valores do potenciômetro 1 são referenciados para o motor da esquerda e os valores do potenciômetro 2 são referenciados para o motor da direita.

  \begin{table}[!ht]
  \centering
  \resizebox{\textwidth}{!}{%
  \begin{tabular}{|c|c|c|c|}
  \hline
  ID & Valor Potenciômetro 1  & Valor Potenciômetro 2  & Estado \\ \hline
  1 & 254 & 255 & Para frente \\ \hline
  2 & 254 & 1 & Virar para direita (próprio eixo) \\ \hline
  3 & 254 & 127 & Virar para direita (eixo motor 2) frontal \\ \hline
  4 & 126 & 127 & Parado \\ \hline
  5 & 126 & 255 & virar para esquerda (eixo motor 1) frontal \\ \hline
  6 & 126 & 1 & virar para esquerda (eixo motor 1) traseiro \\ \hline
  7 & 0 & 1 & Para trás \\ \hline
  8 & 0 & 255 & Virar para esquerda (próprio eixo) \\ \hline
  9 & 0 & 127 & virar para direita (eixo motor 2) traseiro \\ \hline
  \end{tabular}
  }
  \caption{Mapeamento dos estados conforme valores do Joystick}
  \label{tab:tabela-pots}
  \end{table}

  Para elucidar os estados da tabela \ref{tab:tabela-pots} a figura \ref{fig:estados} foi confeccionada.

  \begin{figure}[!ht]
    \center
    \includegraphics[width=0.3\textwidth]{figuras/resultados/estados_1_2_7_8}
    \includegraphics[width=0.3\textwidth]{figuras/resultados/estados_3_5}
    \includegraphics[width=0.3\textwidth]{figuras/resultados/estados_6_9}
    \caption{Imagens lado a lado}
    \label{fig:estados}
  \end{figure}

  \textbf{Mapeamento de Intensidade e Direção dos Motores}

    Conforme os estados mapeados na tabela \ref{tab:tabela-pots}, as intensidades e direções de cada motor são definidas na tabela \ref{tab:tabela-pots2}.

    \begin{table}[!ht]
    \centering
    \resizebox{\textwidth}{!}{%
    \begin{tabular}{|c|c|c|c|}
    \hline
    ID & Estado & Motor 1(Intensidade(\%), Direção) & Motor 2(Intensidade (\%), Direção) \\ \hline
    1 & Para frente & (100, + ) & (100, + ) \\ \hline
    2 & Virar para direita (próprio eixo) & (100, +) & (100, -) \\ \hline
    3 & Virar para direita (eixo motor 2) frontal & (100, +) & (0 , *) \\ \hline
    4 & Parado & (0, *) & (0, *) \\ \hline
    5 & Virar para esquerda (eixo motor 1) frontal & (0, *) & (100, +) \\ \hline
    6 & Virar para esquerda (eixo motor 1) traseiro & (0, *) & (100, -) \\ \hline
    7 & Para trás & (100, -) & (100, -) \\ \hline
    8 & Virar para esquerda (próprio eixo) & (100, -) & (100, +) \\ \hline
    9 & Virar para direita (eixo motor 2) traseiro & (100, -) & (0, *) \\ \hline
    \end{tabular}
    }
    \caption{Intensidade e direção dos motores conforme estado. Asteriscos simbolizam motor sem direção}
    \label{tab:tabela-pots2}
    \end{table}

    \textbf{Integração de \textit{joystick}}

    O hardware utilizado no módulo Joystick, vide capítulo \ref{cap:fundamentacao_teorica}, para fazer o controle da cadeira, foi acoplado usando uma rotação de 45 graus no sentido anti-horário. Isto foi feito para melhorar a interpretação dos dados. Esta translação do eixo XY dos potenciômetros do \textit{joystick}, vide figura \ref{fig:joy_superior}, para o novo eixo M1M2, vide figura, nos permite inserir os estados da tabela \ref{tab:tabela-pots} e implementar estes estados de forma mais fácil.


\begin{comment}
#Controlador central
  - Explicação de código do Rasp
    - Explicação arquitetura paralela(produtor/consumidor)

Motor
  - Software e Hardware (periféricos e MSP Motor)
    - Colocar imagem de código

Integração Motor e Joystick
  - Mapeamento dos estados em relação ao joystick (255,255->Frente)
  - Mapeamento dos estados em relação aos motores (intensidade, direção)
  - Integração via software ou via hardware
    - Soft
      Vantagens: Uso de propósito geral
      Desvantagem: capacidade de Processamento para cálculo de transformação
    - Hardware:
      Vantagens: Valores de intensidade e direção dos motores são adquiridos de forma instanea
      Desvantagem: Não foi observados desvantagens para a aplicação, porém para outros propósitos é mais dificil de se utilizar os dados, pois os mesmos não tem uma relação direta com o plano cartesiano original.

Ponte-H (copiar e colar do documento pc2)
  - Colocar informações sobre dissipador
  - Estanhamento das placas
  - Dimensionamento da largura das trilhas
  - Circuito de direcionamento das PWMs através das seletoras (demultiplexador)

Alimentação do sistema
  - Esquema de alimentação do sistema
  - Circuito regulador de tensão
\end{comment}
